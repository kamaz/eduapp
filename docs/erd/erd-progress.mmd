%% Domain: Progress & Attempts (canonical in D1)
%% Notes:
%% - DO buffers attempts and flushes to D1; idempotency via client-generated key.
%% - No PII in summaries; assets stored in R2 and referenced here.
erDiagram
    %% Referenced entities defined in other ERDs
    CHILDREN_REF_ONBOARDING {}
    ASSETS_REF_ONBOARDING {}
    CURRICULUM_TOPICS_REF_TASKS {}
    TASK_INSTANCES_REF_TASKS {}
    TASK_SET_INSTANCES_REF_TASKS {}
    TASK_ITEM_INSTANCES_REF_TASKS {}

    ATTEMPTS {
        string id PK "ULID. Example: 01HATTEMPT1"
        string child_id FK "FK → children.id"
        string task_instance_id FK "FK → task_instances.id"
        string task_set_instance_id FK "FK → task_set_instances.id (nullable)"
        string task_item_instance_id FK "FK → task_item_instances.id (nullable)"
        string attempt_client_id UK "Idempotency key from client/DO buffer"
        string source "digital|printed. Example: digital"
        string answer_asset_id FK "FK → assets.id (nullable; structured answer)"
        string strokes_asset_id FK "FK → assets.id (nullable; stroke blob)"
        float score "0..1 overall score (nullable)"
        float presentation_score "0..1 presentation/format score (nullable)"
        boolean correct "True when fully correct (nullable)"
        string summary_json "Sanitized summary; no PII"
        int duration_ms "Client-reported duration in ms (nullable)"
        int created_at "Epoch ms created"
    }

    PROGRESS {
        string id PK "ULID. Example: 01HPROG001"
        string child_id FK "FK → children.id"
        string topic_id FK "FK → curriculum_topics.id"
        float mastery "0..1 mastery estimate"
        int attempts_count "Total attempts contributing"
        int last_practiced_at "Epoch ms (nullable)"
        string history_json "Optional compact history (may be replaced by events)"
        int created_at "Epoch ms created"
        int updated_at "Epoch ms updated"
    }

    %% Optional audit trail of mastery evolution (normalized alternative to history_json)
    PROGRESS_EVENTS {
        string id PK "ULID. Example: 01HPEVT001"
        string child_id FK "FK → children.id"
        string topic_id FK "FK → curriculum_topics.id"
        string attempt_id FK "FK → attempts.id (nullable for manual/system)"
        string reason "attempt|manual_adjust|system"
        float delta_mastery "Signed change"
        float mastery_after "Resulting mastery (0..1)"
        int created_at "Epoch ms event time"
    }

    %% Relationships
    CHILDREN_REF_ONBOARDING ||--o{ ATTEMPTS : has
    TASK_INSTANCES_REF_TASKS ||--o{ ATTEMPTS : attempts
    TASK_SET_INSTANCES_REF_TASKS ||--o{ ATTEMPTS : context
    TASK_ITEM_INSTANCES_REF_TASKS ||--o{ ATTEMPTS : context_item

    ASSETS_REF_ONBOARDING ||--o{ ATTEMPTS : answer
    ASSETS_REF_ONBOARDING ||--o{ ATTEMPTS : strokes

    CHILDREN_REF_ONBOARDING ||--o{ PROGRESS : has
    CURRICULUM_TOPICS_REF_TASKS ||--o{ PROGRESS : tracked

    CHILDREN_REF_ONBOARDING ||--o{ PROGRESS_EVENTS : has
    CURRICULUM_TOPICS_REF_TASKS ||--o{ PROGRESS_EVENTS : tracked
    ATTEMPTS ||--o{ PROGRESS_EVENTS : contributes
